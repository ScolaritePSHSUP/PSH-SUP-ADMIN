<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>PSH SUP â€“ Admin RÃ©servations</title>

  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Styles -->
  <link rel="stylesheet" href="/PSH-SUP-ADMIN/style.css">

  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>

<body>

<header class="header">
  <h1>RÃ©servations de salles</h1>
  <p>Validation et gestion des demandes</p>
</header>

<main class="page">

	  <section class="card">
	  <h2>ğŸ“‹ Demandes de rÃ©servation</h2>
	  
	  <div class="filters-bar">
		  <select id="filterStatus">
			<option value="all">Tous les statuts</option>
			<option value="pending">En attente</option>
			<option value="approved">ValidÃ©e</option>
			<option value="refused">RefusÃ©e</option>
		  </select>

		  <select id="filterSalle">
			<option value="all">Toutes les salles</option>
		  </select>

		  <input type="date" id="filterDate" />
		  <button id="filterReset" class="btn-secondary">RÃ©initialiser</button>
		</div>

	  
	  <div id="reservationsList" class="reservations-list">
		<p style="color:#6b7280;text-align:center;">
		  Chargement des rÃ©servationsâ€¦
		</p>
	  </div>
	</section>


</main>

<footer class="footer">
  Â© PSH SUP â€“ Administration â€“ 2026
</footer>

<button id="logout" class="btn-logout-floating">ğŸšª</button>

<script>
document.addEventListener("DOMContentLoaded", () => {

/* ===============================
   ğŸ” SUPABASE CONFIG
=============================== */
const SUPABASE_URL = "https://wqjzgpxcudobdbhtatgw.supabase.co";
const SUPABASE_ANON_KEY = "sb_publishable_RQyY6vwKpcQdlRVFvDVD-A_YybqqTS_";

const supabaseClient = supabase.createClient(
  SUPABASE_URL,
  SUPABASE_ANON_KEY,
  {
    auth: {
      persistSession: true,
      autoRefreshToken: true,
      detectSessionInUrl: false
    }
  }
);

/* ===============================
   ğŸ”’ PROTECTION ADMIN + PUSH
=============================== */
(async () => {
  const { data } = await supabaseClient.auth.getSession();

  if (!data.session || data.session.user.user_metadata.role !== "admin") {
    window.location.href = "admin-login.html";
    return;
  }

  // ğŸ”” permission notif
  if ("Notification" in window && Notification.permission === "default") {
    await Notification.requestPermission();
  }

  // âœ… enregistrer le SW AVANT
  let reg;
  if ("serviceWorker" in navigator) {
    reg = await navigator.serviceWorker.register("/PSH-SUP-ADMIN/admin-sw.js");
    console.log("âœ… Service Worker enregistrÃ©");
  }

  // âœ… attendre qu'il soit prÃªt
  await navigator.serviceWorker.ready;

  // ğŸ”” abonnement push admin
  await subscribeAdminPush();
})();


/* ===============================
   ğŸ”” SUBSCRIBE PUSH ADMIN
=============================== */
function urlBase64ToUint8Array(base64String) {
  const padding = "=".repeat((4 - (base64String.length % 4)) % 4);
  const base64 = (base64String + padding)
    .replace(/-/g, "+")
    .replace(/_/g, "/");

  const rawData = atob(base64);
  const outputArray = new Uint8Array(rawData.length);

  for (let i = 0; i < rawData.length; ++i) {
    outputArray[i] = rawData.charCodeAt(i);
  }

  return outputArray;
}

async function subscribeAdminPush() {
  if (!("serviceWorker" in navigator)) return;

  const reg = await navigator.serviceWorker.ready;

  // ğŸ”¥ on force une nouvelle subscription
  const old = await reg.pushManager.getSubscription();
  if (old) await old.unsubscribe();

  const VAPID_PUBLIC_KEY = "BETw8tFdLbKb_40zgjvMfccOJhnZyvZiKUwKOwWa7TfFdY1EyoxWt__uTaST0_voPfOL6b38KFuJrbVyXTSSKNo";

  const sub = await reg.pushManager.subscribe({
    userVisibleOnly: true,
    applicationServerKey: urlBase64ToUint8Array(VAPID_PUBLIC_KEY)
  });

  const json = sub.toJSON();

  await supabaseClient.from("push_subscriptions").insert({
    audience: "admin",
    endpoint: json.endpoint,
    p256dh: json.keys.p256dh,
    auth: json.keys.auth
  });
}



/* ===============================
   ğŸ§© HELPERS
=============================== */
const el = id => document.getElementById(id);

function normalizeStatus(r) {
  if (r.status) return r.status;
  const s = (r.statut || "").toLowerCase();
  if (s.includes("valid")) return "approved";
  if (s.includes("refus")) return "refused";
  return "pending";
}

function labelStatus(code) {
  return {
    pending: "En attente",
    approved: "ValidÃ©e",
    refused: "RefusÃ©e"
  }[code] || "En attente";
}

function badgeClass(code) {
  return {
    pending: "badge-pending",
    approved: "badge-approved",
    refused: "badge-refused"
  }[code] || "badge-pending";
}

/* ===============================
   ğŸ§  STATE
=============================== */
let allReservations = [];

/* ===============================
   ğŸ“¥ LOAD RESERVATIONS
=============================== */
async function loadReservations() {
  const container = el("reservationsList");
  container.innerHTML = "Chargementâ€¦";

  const { data, error } = await supabaseClient
    .from("reservations_salles")
    .select("*")
    .order("created_at", { ascending: false });

  if (error) {
    console.error(error);
    container.innerHTML = "Erreur de chargement";
    return;
  }

  allReservations = (data || []).map(r => ({
    ...r,
    _status: normalizeStatus(r)
  }));

  fillSalleFilter();
  applyFilters();
}

/* ===============================
   ğŸ« FILTER SALLES
=============================== */
function fillSalleFilter() {
  const select = el("filterSalle");
  const salles = [...new Set(allReservations.map(r => String(r.salle_numero)))]
    .filter(Boolean)
    .sort((a, b) => a.localeCompare(b));

  select.innerHTML =
    `<option value="all">Toutes les salles</option>` +
    salles.map(s => `<option value="${s}">Salle ${s}</option>`).join("");
}

/* ===============================
   ğŸ” FILTERS
=============================== */
function applyFilters() {
  const status = el("filterStatus").value;
  const salle  = el("filterSalle").value;
  const date   = el("filterDate").value;

  let filtered = [...allReservations];

  if (status !== "all") filtered = filtered.filter(r => r._status === status);
  if (salle !== "all") filtered = filtered.filter(r => String(r.salle_numero) === salle);
  if (date) filtered = filtered.filter(r => r.jour === date);

  renderReservations(filtered);
}

/* ===============================
   ğŸ§¾ RENDER
=============================== */
function renderReservations(list) {
  const container = el("reservationsList");
  container.innerHTML = "";

  if (!list.length) {
    container.innerHTML = "<p style='text-align:center;color:#6b7280;'>Aucune rÃ©servation</p>";
    return;
  }

  list.forEach(r => {
    const statusCode = r._status;

    container.innerHTML += `
      <div class="reservation-card">
        <div class="reservation-header">
          <strong>Salle ${r.salle_numero}</strong>
          <span class="badge ${badgeClass(statusCode)}">${labelStatus(statusCode)}</span>
        </div>

        <div class="reservation-body">
          <p>ğŸ“… ${r.jour}</p>
          <p>â° ${String(r.heure_debut).slice(0,5)} â€“ ${String(r.heure_fin).slice(0,5)}</p>
          <p>ğŸ‘¤ ${r.nom} â€“ ${r.classe}</p>
          <p>ğŸ“ ${r.motif}</p>
        </div>

        <div class="reservation-actions">
          ${
            statusCode === "pending"
              ? `
                <button class="btn-success" data-id="${r.id}" data-status="approved">âœ” Valider</button>
                <button class="btn-danger"  data-id="${r.id}" data-status="refused">âœ– Refuser</button>
              `
              : `<span class="muted">â€”</span>`
          }
        </div>
      </div>
    `;
  });

  document.querySelectorAll(".reservation-actions button").forEach(btn => {
    btn.addEventListener("click", async () => {
      await updateStatus(btn.dataset.id, btn.dataset.status);
    });
  });
}

/* ===============================
   âœ… UPDATE STATUS
=============================== */
async function updateStatus(id, status) {
  const { error } = await supabaseClient
    .from("reservations_salles")
    .update({
      status,
      statut: labelStatus(status)
    })
    .eq("id", id);

  if (error) {
    alert("Erreur mise Ã  jour");
    return;
  }

  loadReservations();
}

/* ===============================
   ğŸ”” REALTIME ADMIN (UI only)
=============================== */
supabaseClient
  .channel("admin-reservations")
  .on(
    "postgres_changes",
    { event: "INSERT", schema: "public", table: "reservations_salles" },
    payload => {
      console.log("ğŸ”” Nouvelle rÃ©servation realtime");
      loadReservations();
      showToast(payload.new);
    }
  )
  .subscribe();

/* ===============================
   ğŸ”” TOAST UI
=============================== */
function showToast(r) {
  const n = document.createElement("div");
  n.className = "admin-notification";
  n.innerHTML = `
    ğŸ”” Nouvelle rÃ©servation<br>
    <strong>Salle ${r.salle_numero}</strong><br>
    ${r.jour} ${String(r.heure_debut).slice(0,5)} â€“ ${String(r.heure_fin).slice(0,5)}
  `;
  document.body.appendChild(n);

  setTimeout(() => n.classList.add("show"), 50);
  setTimeout(() => {
    n.classList.remove("show");
    setTimeout(() => n.remove(), 300);
  }, 4000);
}

/* ===============================
   ğŸ›ï¸ EVENTS
=============================== */
el("filterStatus").addEventListener("change", applyFilters);
el("filterSalle").addEventListener("change", applyFilters);
el("filterDate").addEventListener("change", applyFilters);
el("filterReset").addEventListener("click", () => {
  el("filterStatus").value = "all";
  el("filterSalle").value = "all";
  el("filterDate").value = "";
  applyFilters();
});

/* ===============================
   ğŸš€ INIT
=============================== */
loadReservations();

});

</script>



</body>
</html>
