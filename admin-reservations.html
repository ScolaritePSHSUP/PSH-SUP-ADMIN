<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>PSH SUP â€“ Admin RÃ©servations</title>

  <meta name="viewport" content="width=device-width, initial-scale=1">

  <link rel="stylesheet" href="/PSH-SUP-ADMIN/style.css">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>

<body>

<header class="header">
  <h1>Admin â€“ RÃ©servations de salles</h1>
  <p>Validation des demandes</p>
</header>

<center>
  <a href="index.html" class="btn-secondary">â¬… Retour dashboard</a>
</center>

<main class="admin-grid">

  <!-- FILTRES -->
  <section class="admin-list">
    <h2>Filtres</h2>

    <div class="admin-filters">
      <button onclick="setFilter('pending')" class="btn-primary">â³ En attente</button>
      <button onclick="setFilter('approved')" class="btn-secondary">âœ… ValidÃ©es</button>
      <button onclick="setFilter('refused')" class="btn-secondary">âŒ RefusÃ©es</button>
    </div>
  </section>

  <!-- LISTE -->
  <section class="admin-list">
    <h2>RÃ©servations</h2>
    <div id="adminReservationsList"></div>
  </section>

</main>

<button id="logout" class="btn-logout-floating">ğŸšª</button>

<script>
/* ===============================
   ğŸ” SUPABASE CONFIG
=============================== */
const SUPABASE_URL = "https://wqjzgpxcudobdbhtatgw.supabase.co";
const SUPABASE_ANON_KEY = "sb_publishable_RQyY6vwKpcQdlRVFvDVD-A_YybqqTS_";

const supabaseClient = supabase.createClient(
  SUPABASE_URL,
  SUPABASE_ANON_KEY,
  {
    auth: {
      persistSession: true,
      autoRefreshToken: true,
      detectSessionInUrl: false
    }
  }
);

/* ===============================
   ğŸ”’ PROTECTION ADMIN
=============================== */
(async () => {
  const { data } = await supabaseClient.auth.getSession();
  if (!data.session || data.session.user.user_metadata.role !== "admin") {
    window.location.href = "admin-login.html";
  }
})();

/* ===============================
   ğŸ§  Ã‰TAT
=============================== */
let currentFilter = "pending";

/* ===============================
   ğŸ” LOAD RESERVATIONS
=============================== */
async function loadReservations() {
  const { data, error } = await supabaseClient
    .from("reservations_salles")
    .select("*")
    .eq("status", currentFilter)
    .order("jour", { ascending: true })
    .order("heure_debut");

  const container = document.getElementById("adminReservationsList");
  container.innerHTML = "";

  if (error || !data.length) {
    container.innerHTML = "<p>Aucune rÃ©servation</p>";
    return;
  }

  data.forEach(r => {
    container.innerHTML += `
      <div class="admin-actu-card">
        <h3>${r.nom} â€“ ${r.classe}</h3>
        <small>
          Salle ${r.salle_numero}<br>
          ğŸ“… ${r.jour}<br>
          â° ${r.heure_debut} â†’ ${r.heure_fin}<br>
          âœ‰ï¸ ${r.email || "â€”"}<br>
          ğŸ“ ${r.motif || "â€”"}<br>
          Statut : <strong>${r.status}</strong>
        </small>

        ${
          r.status === "pending"
            ? `<div class="admin-actions">
                <button onclick="approveReservation('${r.id}')">âœ… Valider</button>
                <button onclick="rejectReservation('${r.id}')">âŒ Refuser</button>
              </div>`
            : ""
        }
      </div>
    `;
  });
}

/* ===============================
   ğŸ›ï¸ FILTRES
=============================== */
function setFilter(status) {
  currentFilter = status;
  loadReservations();
}

/* ===============================
   âœ… APPROUVER
=============================== */
async function approveReservation(id) {
  await supabaseClient
    .from("reservations_salles")
    .update({ status: "approved" })
    .eq("id", id);

  loadReservations();
}

/* ===============================
   âŒ REFUSER
=============================== */
async function rejectReservation(id) {
  await supabaseClient
    .from("reservations_salles")
    .update({ status: "refused" })
    .eq("id", id);

  loadReservations();
}

/* ===============================
   ğŸšª LOGOUT
=============================== */
logout.onclick = async () => {
  await supabaseClient.auth.signOut();
  window.location.href = "admin-login.html";
};

/* ===============================
   ğŸš€ INIT
=============================== */
loadReservations();
</script>

</body>
</html>
