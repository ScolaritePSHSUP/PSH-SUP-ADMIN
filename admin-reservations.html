<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>PSH SUP â€“ Admin RÃ©servations</title>

  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Styles -->
  <link rel="stylesheet" href="/PSH-SUP-ADMIN/style.css">

  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>

<body>

<header class="header">
  <h1>RÃ©servations de salles</h1>
  <p>Validation et gestion des demandes</p>
</header>

<main class="page">

  <section class="card">
    <h2>ğŸ“‹ Demandes de rÃ©servation</h2>

    <table class="admin-table">
      <thead>
        <tr>
          <th>Salle</th>
          <th>Date</th>
          <th>Heure</th>
          <th>Nom</th>
          <th>Classe</th>
          <th>Motif</th>
          <th>Statut</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="reservationsTable">
        <tr>
          <td colspan="8" style="text-align:center;color:#6b7280;">
            Chargement des rÃ©servationsâ€¦
          </td>
        </tr>
      </tbody>
    </table>
  </section>

</main>

<footer class="footer">
  Â© PSH SUP â€“ Administration â€“ 2026
</footer>

<button id="logout" class="btn-logout-floating">ğŸšª</button>

<script>
/* ===============================
   ğŸ” SUPABASE CONFIG
=============================== */
const SUPABASE_URL = "https://wqjzgpxcudobdbhtatgw.supabase.co";
const SUPABASE_ANON_KEY = "sb_publishable_RQyY6vwKpcQdlRVFvDVD-A_YybqqTS_";

const supabaseClient = supabase.createClient(
  SUPABASE_URL,
  SUPABASE_ANON_KEY,
  {
    auth: {
      persistSession: true,
      autoRefreshToken: true,
      detectSessionInUrl: false
    }
  }
);

/* ===============================
   ğŸ”’ PROTECTION ADMIN
=============================== */
(async () => {
  const { data } = await supabaseClient.auth.getSession();

  if (!data.session || data.session.user.user_metadata.role !== "admin") {
    window.location.href = "admin-login.html";
  }
})();

/* ===============================
   ğŸ“‹ LOAD RÃ‰SERVATIONS
=============================== */
async function loadReservations() {
  const tbody = document.getElementById("reservationsTable");

  const { data, error } = await supabaseClient
    .from("reservations_salles")
    .select("*")
    .order("created_at", { ascending: false });

  if (error) {
    console.error(error);
    tbody.innerHTML = `
      <tr>
        <td colspan="8" style="color:red;text-align:center;">
          Erreur de chargement
        </td>
      </tr>`;
    return;
  }

  if (!data || data.length === 0) {
    tbody.innerHTML = `
      <tr>
        <td colspan="8" style="text-align:center;color:#6b7280;">
          Aucune rÃ©servation
        </td>
      </tr>`;
    return;
  }

  tbody.innerHTML = "";

  data.forEach(r => {
    const statutLabel = {
      pending: "ğŸŸ¡ En attente",
      approved: "âœ… ValidÃ©e",
      refused: "âŒ RefusÃ©e"
    }[r.status];

    tbody.innerHTML += `
      <tr>
        <td><strong>${r.salle_numero}</strong></td>
        <td>${r.jour}</td>
        <td>${r.heure_debut.slice(0,5)} â€“ ${r.heure_fin.slice(0,5)}</td>
        <td>${r.nom}</td>
        <td>${r.classe}</td>
        <td style="max-width:220px;">${r.motif}</td>
        <td>${statutLabel}</td>
        <td>
          ${
            r.status === "pending"
              ? `
                <button class="btn-small btn-success"
                        onclick="updateStatus('${r.id}', 'approved')">
                  Valider
                </button>
                <button class="btn-small btn-danger"
                        onclick="updateStatus('${r.id}', 'refused')">
                  Refuser
                </button>
              `
              : "â€”"
          }
        </td>
      </tr>
    `;
  });
}

/* ===============================
   âœ… / âŒ UPDATE STATUS
=============================== */
async function updateStatus(id, status) {
  const confirmMsg =
    status === "approved"
      ? "Valider cette rÃ©servation ?"
      : "Refuser cette rÃ©servation ?";

  if (!confirm(confirmMsg)) return;

  const { error } = await supabaseClient
    .from("reservations_salles")
    .update({ status })
    .eq("id", id);

  if (error) {
    alert("Erreur lors de la mise Ã  jour");
    console.error(error);
    return;
  }

  loadReservations();
}

/* ===============================
   ğŸšª LOGOUT
=============================== */
document.getElementById("logout").addEventListener("click", async () => {
  await supabaseClient.auth.signOut();
  window.location.href = "admin-login.html";
});

/* ===============================
   ğŸš€ INIT
=============================== */
loadReservations();
</script>

</body>
</html>
